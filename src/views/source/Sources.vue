<!--
 * @name: 
 * @author: SunSeekerX
 * @Date: 2020-07-28 09:28:09
 * @LastEditors: SunSeekerX
 * @LastEditTime: 2020-08-10 21:59:54
-->

<template>
  <page-header-wrapper>
    <a-card :bordered="false">
      <div class="table-operator">
        <a-row align="middle" type="flex">
          <a-col :xs="24" :md="12">
            <a-button type="primary" icon="plus" @click="state.isCreateShow = true">新建</a-button>
          </a-col>

          <a-col :xs="24" :md="12">
            <a-tabs v-model="sourcesType" size="small" @change="onGetSources">
              <a-tab-pane key="1">
                <span slot="tab">
                  <a-icon type="android" />WGT
                </span>
              </a-tab-pane>

              <a-tab-pane key="2">
                <span slot="tab">
                  <a-icon type="apple" />WGT
                </span>
              </a-tab-pane>

              <a-tab-pane key="3">
                <span slot="tab">
                  <a-icon type="android" />Android
                </span>
              </a-tab-pane>

              <a-tab-pane key="4">
                <span slot="tab">
                  <a-icon type="apple" />Apple
                </span>
              </a-tab-pane>
            </a-tabs>
          </a-col>
        </a-row>

        <!-- <a-select default-value="wgt" style="width: 120px" @change="selectChange">
          <a-select-option value="wgt">wgt</a-select-option>
          <a-select-option value="android">android</a-select-option>
          <a-select-option value="ios">ios</a-select-option>
        </a-select>-->
      </div>

      <!-- 资源表格 -->
      <a-table
        :columns="tableColumns"
        :data-source="tableData"
        :loading="state.isTableLoading"
        rowKey="id"
        :pagination="pagination"
        @change="pageChange"
      >
        <!-- url -->
        <span slot="url" slot-scope="url">{{ handleFormatUrl(url) }}</span>

        <!-- 强制更新 -->
        <span slot="isForceUpdate" slot-scope="isForceUpdate">{{ isForceUpdate === 0 ? '否' : '是' }}</span>

        <!-- 类型 -->
        <span slot="sourcesType" slot-scope="text, record">{{ handleFormatType(record.type) }}</span>

        <!-- 操作 -->
        <!-- <a-button slot="action" type="primary">查看资源</a-button> -->
        <template slot="action" slot-scope="text, record,index">
          <a-button @click="onEdit(record)">编辑</a-button>

          <a-popconfirm
            title="确定删除该资源?"
            ok-text="确定"
            cancel-text="取消"
            @confirm="onDelete(record, index)"
          >
            <a-button type="danger">删除</a-button>
          </a-popconfirm>
        </template>
      </a-table>

      <!-- 新建 -->
      <a-modal
        title="新建资源"
        :width="640"
        :visible="state.isCreateShow"
        :confirmLoading="state.isCreateLoading"
        @ok="onCreateSource"
        @cancel="state.isCreateShow = false"
      >
        <a-form-model
          ref="createForm"
          :model="form"
          :rules="rules"
          :label-col="labelCol"
          :wrapper-col="wrapperCol"
        >
          <a-form-model-item label="项目ID" ref="projectId" prop="projectId">
            <a-input disabled v-model="form.projectId" prop="projectId" />
          </a-form-model-item>

          <a-form-model-item label="版本" ref="version" prop="version">
            <a-input v-model="form.version" />
          </a-form-model-item>

          <a-form-model-item label="版本号" ref="versionCode" prop="versionCode">
            <a-input
              @change="e => form.versionCode = Number(e.target.value.replace(/\D/g, ''))"
              v-model="form.versionCode"
            />
          </a-form-model-item>

          <a-form-model-item label="原生应用版本号" ref="nativeVersionCode" prop="nativeVersionCode">
            <a-input
              @change="e => form.nativeVersionCode = Number(e.target.value.replace(/\D/g, ''))"
              v-model="form.nativeVersionCode"
            />
          </a-form-model-item>

          <a-form-model-item label="是否强制更新" prop="isForceUpdate">
            <a-radio-group v-model="form.isForceUpdate">
              <a-radio :value="0">否</a-radio>
              <a-radio :value="1">是</a-radio>
            </a-radio-group>
          </a-form-model-item>

          <a-form-model-item label="类型" prop="type">
            <a-select v-model="form.type">
              <a-select-option :value="1">wgt-android</a-select-option>
              <a-select-option :value="2">wgt-ios</a-select-option>
              <a-select-option :value="3">android</a-select-option>
              <a-select-option :value="4">ios</a-select-option>
            </a-select>
          </a-form-model-item>

          <a-form-model-item label="备注" ref="remark" prop="remark">
            <a-textarea v-model="form.remark" />
          </a-form-model-item>

          <a-form-model-item label="资源包" prop="url">
            <a-upload
              name="file"
              accept=".wgt, .apk"
              :headers="headers"
              :action="uploadAcrion"
              @change="handleChange"
              :remove="onRemoveFile"
            >
              <a-button :disabled="fileList.length > 0">
                <a-icon type="upload" />点击上传资源
              </a-button>
            </a-upload>
          </a-form-model-item>
        </a-form-model>
      </a-modal>

      <!-- 编辑资源 -->
      <a-modal
        title="编辑资源"
        :width="640"
        :visible="state.isEditFormShow"
        :confirmLoading="state.isEditLoading"
        @ok="onEditConfirm"
        @cancel="state.isEditFormShow = false"
      >
        <a-form-model
          ref="editForm"
          :model="editForm"
          :rules="editFormRules"
          :label-col="labelCol"
          :wrapper-col="wrapperCol"
        >
          <a-form-model-item label="ID" prop="id">
            <a-input v-model="editForm.id" disabled="disabled" />
          </a-form-model-item>

          <a-form-model-item label="版本" prop="version">
            <a-input v-model="editForm.version" />
          </a-form-model-item>

          <a-form-model-item label="版本号" prop="versionCode">
            <a-input
              @change="e => editForm.versionCode = Number(e.target.value.replace(/\D/g, ''))"
              v-model="editForm.versionCode"
            />
          </a-form-model-item>

          <a-form-model-item label="原生应用版本号" ref="nativeVersionCode" prop="nativeVersionCode">
            <a-input
              @change="e => editForm.nativeVersionCode = Number(e.target.value.replace(/\D/g, ''))"
              v-model="editForm.nativeVersionCode"
            />
          </a-form-model-item>

          <a-form-model-item label="是否强制更新" prop="isForceUpdate">
            <a-radio-group v-model="editForm.isForceUpdate">
              <a-radio :value="0">否</a-radio>
              <a-radio :value="1">是</a-radio>
            </a-radio-group>
          </a-form-model-item>

          <a-form-model-item label="类型" prop="type">
            <a-select v-model="editForm.type">
              <a-select-option :value="1">wgt-android</a-select-option>
              <a-select-option :value="2">wgt-ios</a-select-option>
              <a-select-option :value="3">android</a-select-option>
              <a-select-option :value="4">ios</a-select-option>
            </a-select>
          </a-form-model-item>

          <a-form-model-item label="备注" ref="remark" prop="remark">
            <a-textarea v-model="editForm.remark" />
          </a-form-model-item>

          <a-form-model-item label="资源包地址" prop="url">
            <a-input v-model="editForm.url" disabled="disabled" />
          </a-form-model-item>
        </a-form-model>
      </a-modal>
    </a-card>
  </page-header-wrapper>
</template>

<script>
import storage from 'store'
import { ACCESS_TOKEN } from '@/store/mutation-types'

export default {
  name: 'BasicSource',

  data() {
    return {
      labelCol: { xs: { span: 24 }, sm: { span: 7 } },
      wrapperCol: { xs: { span: 24 }, sm: { span: 13 } },
      // 字典
      dict: {
        // 资源类型
        sourcesType: {
          1: 'wgt-android',
          2: 'wgt-ios',
          3: 'android',
          4: 'ios',
        },
      },
      // 状态
      state: {
        // 表格是否加载
        isTableLoading: false,
        // 创建表格是否显示
        isCreateShow: false,
        // 创建按钮是否加载
        isCreateLoading: false,
        // 修改表格是否显示
        isEditFormShow: false,
        // 编辑是否加载
        isEditLoading: false,
      },
      // 表头
      tableColumns: [
        // ID
        {
          title: 'ID',
          dataIndex: 'id',
        },
        // 版本
        {
          title: '版本',
          dataIndex: 'version',
        },
        // 版本号
        {
          title: '版本号',
          dataIndex: 'versionCode',
        },
        // 原生应用版本号
        {
          title: '原生应用版本号',
          dataIndex: 'nativeVersionCode',
        },
        // 下载地址
        {
          title: '下载地址',
          dataIndex: 'url',
          scopedSlots: { customRender: 'url' },
          width: 200,
          // ellipsis: true,
        },
        // 强制更新
        {
          title: '强制更新',
          dataIndex: 'isForceUpdate',
          scopedSlots: { customRender: 'isForceUpdate' },
        },
        // 类型
        {
          title: '类型',
          dataIndex: 'sourcesType',
          scopedSlots: { customRender: 'sourcesType' },
        },
        // 备注
        {
          title: '备注',
          dataIndex: 'remark',
        },
        // 创建时间
        {
          title: '创建时间',
          dataIndex: 'createdTime',
        },
        // 更新时间
        {
          title: '更新时间',
          dataIndex: 'updatedTime',
        },
        // 操作
        {
          title: '操作',
          scopedSlots: { customRender: 'action' },
          fixed: 'right',
        },
      ],
      // 资源类型
      sourcesType: '1',
      // 表格数据
      tableData: [],
      // 文件数据
      fileList: [],
      // 分页
      pagination: {
        total: 0,
        pageSize: 10,
        defaultCurrent: 1,
        pageNum: 1,
      },
      // 新增表格
      form: {
        // 项目ID
        projectId: 0,
        // 版本
        version: '',
        // 版本号
        versionCode: 0,
        // 原生应用版本号
        nativeVersionCode: 0,
        // 是否强制更新
        isForceUpdate: 0,
        // 类型
        type: 1,
        // 备注
        remark: '',
        // 资源包
        url: '',
      },
      // 新增表格rules
      rules: {
        // 项目ID
        projectId: [
          {
            required: true,
            type: 'integer',
            message: '请输入正确的项目ID！',
          },
        ],
        // 版本
        version: [{ required: true, type: 'string', message: '请输入版本！' }],
        // 版本号
        versionCode: [
          {
            required: true,
            type: 'integer',
            message: '请输入正确的版本号！',
          },
          {
            type: 'integer',
            min: 1,
            message: '版本号必须大于0！',
          },
        ],
        // 原生应用版本号
        nativeVersionCode: [
          {
            required: false,
            type: 'integer',
            message: '请输入正确的原生应用版本号！',
          },
          {
            validator: this.handleValideNativeVersionCode,
          },
        ],
        // 备注
        remark: [{ required: false, type: 'string', message: '请输入备注！' }],
        // 是否强制更新（0：否 1：是）
        isForceUpdate: [
          {
            required: true,
            message: '请选择是否强制更新！',
          },
        ],
        // 资源类型（1：wgt-android 2：wgt-ios  3：android，4：ios）
        type: [
          {
            required: true,
            message: '请选择类型！',
            trigger: 'change',
          },
        ],
        // 下载地址
        url: [
          {
            required: true,
            message: '请上传资源包！',
          },
        ],
      },
      // 上传文件header
      headers: {
        Authorization: `Bearer ${storage.get(ACCESS_TOKEN)}`,
      },
      // 编辑的行数据
      editForm: {},
      // 编辑表格rules
      editFormRules: {
        // 项目ID
        projectId: [
          {
            required: true,
            type: 'integer',
            message: '请输入正确的项目ID！',
          },
        ],
        // 版本
        version: [{ required: true, type: 'string', message: '请输入版本！' }],
        // 版本号
        versionCode: [
          {
            required: true,
            type: 'integer',
            message: '请输入正确的版本号！',
          },
          {
            type: 'integer',
            min: 1,
            message: '版本号必须大于0！',
          },
        ],
        // 原生应用版本号
        nativeVersionCode: [
          {
            required: false,
            type: 'integer',
            message: '请输入正确的原生应用版本号！',
          },
          {
            validator: this.handleValideEditNativeVersionCode,
          },
        ],
        // 备注
        remark: [{ required: false, type: 'string', message: '请输入备注！' }],
        // 是否强制更新（0：否 1：是）
        isForceUpdate: [
          {
            required: true,
            message: '请选择是否强制更新！',
          },
        ],
        // 资源类型（1：wgt-android 2：wgt-ios  3：android，4：ios）
        type: [
          {
            required: true,
            message: '请选择类型！',
            trigger: 'change',
          },
        ],
        // 下载地址
        url: [
          {
            required: true,
            message: '请上传资源包！',
          },
        ],
      },
      // 上传文件地址
      uploadAcrion: `${process.env.VUE_APP_API_BASE_URL}/api/upload`,
    }
  },

  methods: {
    // 获取资源列表
    async onGetSources() {
      try {
        this.state.isTableLoading = true
        const res = await this.$api.Source.sources({
          id: this.form.projectId,
          type: this.sourcesType,
          pageNum: this.pagination.pageNum,
          pageSize: this.pagination.pageSize,
        })
        if (res.success) {
          this.tableData = res.data.records
          this.pagination.total = res.data.total
        } else {
          this.$handleError.handleRequestFail(res.message)
        }
      } catch (error) {
        this.$handleError.handleApiRequestException(error)
      } finally {
        this.state.isTableLoading = false
      }
    },

    // 新建资源
    async onCreateSource() {
      this.$refs.createForm.validate(async valid => {
        if (valid) {
          try {
            this.state.isCreateLoading = true
            const res = await this.$api.Source.createSource(this.form)
            if (res.success) {
              this.$notification.success({
                message: '成功',
                description: res.message,
              })
              this.state.isCreateShow = false
              this.state.isCreateLoading = false

              if (this.form.type === Number(this.sourcesType)) {
                // 添加数据
                this.tableData.push(res.data)
              }
            } else {
              this.$handleError.handleRequestFail(res.message)
            }
          } catch (error) {
            this.$handleError.handleApiRequestException(error)
          } finally {
            this.state.isCreateLoading = false
          }
        } else {
          this.state.isCreateLoading = false
        }
      })
    },

    selectChange(e) {
      if (e === 'android') {
        this.sourcesType = 3
        this.onGetSources()
      } else if (e === 'ios') {
        this.sourcesType = 2
        this.onGetSources()
      } else {
        this.sourcesType = 0
        this.onGetSources()
      }
    },

    // 文件上传状态发生变化
    handleChange(info) {
      const status = info.file.status

      if (status === 'done') {
        this.form.url = info.fileList[0].response.data.customName
        this.$message.success(`${info.file.name} 上传成功。`)
      } else if (status === 'error') {
        this.$message.error(`${info.file.name} 上传失败。`)
      }

      this.fileList = info.fileList
    },

    // 移除上传的文件
    onRemoveFile() {
      this.form.url = ''
      return true
    },

    handleFormatUrl(url) {
      return `${process.env.VUE_APP_OSS_BASE_URL}/${url}`
    },

    pageChange(e) {
      this.pagination.pageNum = e.current
      this.onGetSources()
    },

    // 点击编辑
    onEdit(record) {
      // 合并编辑项
      this.editForm = Object.assign({}, record)
      // 显示编辑modal
      this.state.isEditFormShow = true
    },

    // 编辑资源确定
    async onEditConfirm() {
      this.$refs.editForm.validate(async valid => {
        if (valid) {
          try {
            this.state.isEditLoading = true
            const res = await this.$api.Source.updateSource(this.editForm)
            if (res.success) {
              this.$notification.success({
                message: '成功',
                description: res.message,
              })

              this.state.isEditFormShow = false

              this.onGetSources()
            } else {
              this.$handleError.handleRequestFail(res.message)
            }
          } catch (error) {
            this.$handleError.handleApiRequestException(error)
          } finally {
            this.state.isEditLoading = false
          }
        } else {
          this.state.isEditLoading = false
        }
      })
    },

    // 删除资源
    async onDelete(record, index) {
      try {
        const res = await this.$api.Source.deleteSource({
          id: record.id,
        })

        if (res.success) {
          this.$notification.success({
            message: '成功',
            description: res.message,
          })

          this.tableData.splice(index, 1)
        } else {
          this.$handleError.handleRequestFail(res.message)
        }
      } catch (error) {
        this.$handleError.handleApiRequestException(error)
      } finally {
        this.state.isCreateLoading = false
      }
    },

    // 校验新增原生版本号
    handleValideNativeVersionCode(rule, value, callback) {
      const { type } = this.form
      if (type === 1 || type === 2) {
        if (typeof value !== 'number') {
          callback(new Error('请输入正确的原生版本号！'))
        } else if (value <= 0) {
          callback(new Error('wgt资源的原生版本号必须大于0！'))
        } else {
          callback()
        }
      } else {
        callback()
      }
    },

    // 校验编辑原生版本号
    handleValideEditNativeVersionCode(rule, value, callback) {
      const { type } = this.editForm
      if (type === 1 || type === 2) {
        if (typeof value !== 'number') {
          callback(new Error('请输入正确的原生版本号！'))
        } else if (value <= 0) {
          callback(new Error('wgt资源的原生版本号必须大于0！'))
        } else {
          callback()
        }
      } else {
        callback()
      }
    },

    // 格式化表格类型
    handleFormatType(type) {
      if (this.dict.sourcesType[type]) {
        return this.dict.sourcesType[type]
      } else {
        return '未知'
      }
    },
  },

  created() {
    // 获取项目id
    this.form.projectId = Number(this.$route.query.id)
  },

  mounted() {
    // 获取资源列表
    this.onGetSources()
  },
}
</script>

<style lang="scss" scoped></style>
